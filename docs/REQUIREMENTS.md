# 要求仕様（Requirements）

## 目的

Windows 上で、画面キャプチャ → 画像処理 → HID送信を **低レイテンシ**で継続実行する。

## スコープ

### 対象

- OS: Windows
- 主なパイプライン: Capture / Process / HID / Stats(UI) の4スレッド構成
- 画面キャプチャ: DXGI Desktop Duplication API（DDA）
- 画像処理: OpenCV を用いた HSV 色検知（"fast-color"）
- 通信: HID（hidapi）

### 非スコープ

- "yolo-ort" モードの実装（設定値としては存在するが、現状未実装）
- DirtyRect 最適化（設定項目はあるが、現状は未実装/無効扱い）
- UI（GUI）

## 機能要件

### 1. 設定の外部化

- `config.toml`（存在しない場合はデフォルト）から設定を読み込む
- 読み込んだ設定は妥当性検証され、不正なら実行を停止する

### 2. キャプチャ

- 指定モニタ（`capture.monitor_index`）からフレーム取得を試みる
- フレーム更新がない場合はタイムアウトとして扱い、パイプラインは継続する
- 排他的フルスクリーン等で取得不能になった場合でも、可能な限り自動復旧を試みる

### 3. ROI（Region of Interest）

- ROI は **画面中心に自動配置**される
  - 設定は `width/height` のみを持ち、`x/y` は実行時に画面解像度から計算する

### 4. 画像処理（fast-color）

- HSV の範囲指定に基づき色検知を行う
- 検出結果として、少なくとも以下の情報を扱えること
  - 検出有無
  - 検出重心（ROI内）
  - 検出面積（coverage）

### 5. HID送信

- 検出結果を HID レポートとして送信する
- デバイスが未接続/不安定でも、可能な限り再接続を試みる
- `vendor_id/product_id` が `0x0000` の場合、モック通信に切り替え可能であること（実HID送信を行わない）

### 6. 実行時の有効/無効切り替え

- Insertキー等の入力で、HID送信の有効/無効を切り替えられる（RuntimeState）
- 切り替え時に音声フィードバックを行える（Windows PlaySoundW）

## 非機能要件

### レイテンシ

- 目標: エンドツーエンドで 10ms 以下（144Hz環境を想定）
- 設計上の方針: 「最新のみ」ポリシー（bounded(1) 等）でバックプレッシャを避ける

### 信頼性

- DDA の `AccessLost` 等の回復可能エラーから自動復旧する
- 連続タイムアウトなどの異常検出により、再初期化をトリガする

### 観測性（Observability）

- Debug/開発時は tracing によるログ・計測を行える
- Release ビルドではログ関連のオーバーヘッドを極力排除する

## Assumptions（前提）

- 実行対象は "メインモニタの排他的フルスクリーン" のユースケースを想定している
- HID レポートの詳細フォーマット（ReportID/バイト配置）は、接続先デバイス仕様に依存する

## Questions（要確認）

- 実運用での目標送信レート（`hid_send_interval_ms`）は 144Hz 固定か、可変か
- HID レポート仕様（バイト配列の意味、座標スケール等）をどこにドキュメント化するか
